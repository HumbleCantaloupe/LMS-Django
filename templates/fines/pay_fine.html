{% extends 'base.html' %}
{% load static %}

{% block title %}Pay Fine - Library Management System{% endblock %}

{% block extra_css %}
<style>
    .fine-card {
        border: 2px solid #dee2e6;
        border-radius: 15px;
        transition: all 0.3s ease;
    }
    
    .fine-card.overdue {
        border-color: #dc3545;
    }
    
    .fine-card.pending {
        border-color: #ffc107;
    }
    
    .fine-card.paid {
        border-color: #28a745;
    }
    
    .payment-method-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .payment-method-card:hover {
        border-color: #007bff;
        transform: translateY(-2px);
    }
    
    .payment-method-card.selected {
        border-color: #007bff;
        background-color: #e7f3ff;
    }
    
    .fine-amount {
        font-size: 2rem;
        font-weight: bold;
    }
    
    .payment-summary {
        background-color: #f8f9fa;
        border-radius: 10px;
        border-left: 4px solid #007bff;
    }
    
    .status-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 500;
    }
    
    .status-overdue {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .status-pending {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .status-partial {
        background-color: #d1ecf1;
        color: #0c5460;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url 'home' %}">
                            <i class="fas fa-home"></i> Home
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{% url 'fines:list' %}">Fines</a>
                    </li>
                    <li class="breadcrumb-item active">Pay Fine</li>
                </ol>
            </nav>

            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h2 mb-1">
                        <i class="fas fa-credit-card text-primary me-2"></i>
                        Pay Fine
                    </h1>
                    <p class="text-muted mb-0">Complete your fine payment to restore full library privileges</p>
                </div>
                <div>
                    <a href="{% url 'fines:list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Fines
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Fine Details -->
        <div class="col-md-6">
            <div class="card fine-card {{ fine.status }} h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Fine Details
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Fine Type and Status -->
                    <div class="row mb-3">
                        <div class="col-6">
                            <strong>Type:</strong>
                            <div class="mt-1">
                                <span class="badge bg-info">{{ fine.get_fine_type_display }}</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <strong>Status:</strong>
                            <div class="mt-1">
                                <span class="status-badge status-{{ fine.status }}">
                                    {% if fine.status == 'overdue' %}
                                        <i class="fas fa-clock"></i>
                                    {% elif fine.status == 'pending' %}
                                        <i class="fas fa-exclamation-circle"></i>
                                    {% elif fine.status == 'partial' %}
                                        <i class="fas fa-circle-half-stroke"></i>
                                    {% endif %}
                                    {{ fine.get_status_display }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Amounts -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <strong>Total Amount:</strong>
                            <div class="fine-amount text-danger">MVR {{ fine.amount }}</div>
                        </div>
                    </div>

                    {% if fine.amount_paid > 0 %}
                    <div class="row mb-3">
                        <div class="col-6">
                            <strong>Amount Paid:</strong>
                            <div class="text-success fs-5">MVR {{ fine.amount_paid }}</div>
                        </div>
                        <div class="col-6">
                            <strong>Balance Due:</strong>
                            <div class="text-warning fs-5">MVR {{ fine.balance }}</div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Description -->
                    <div class="mb-3">
                        <strong>Description:</strong>
                        <p class="text-muted mt-1">{{ fine.description|default:"No additional details available." }}</p>
                    </div>

                    <!-- Related Information -->
                    {% if fine.book_copy %}
                    <div class="mb-3">
                        <strong>Related Book:</strong>
                        <div class="mt-1">
                            <a href="{% url 'books:book_detail' fine.book_copy.book.id %}" class="text-decoration-none">
                                <i class="fas fa-book me-2"></i>{{ fine.book_copy.book.title }}
                            </a>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Due Date -->
                    <div class="row">
                        <div class="col-6">
                            <strong>Imposed On:</strong>
                            <div class="text-muted">{{ fine.imposed_at|date:"M d, Y g:i A" }}</div>
                        </div>
                        <div class="col-6">
                            <strong>Due Date:</strong>
                            <div class="{% if fine.is_overdue_fine %}text-danger{% else %}text-muted{% endif %}">
                                {{ fine.due_date|date:"M d, Y" }}
                                {% if fine.is_overdue_fine %}
                                    <i class="fas fa-exclamation-triangle ms-1"></i>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Form -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-payment me-2"></i>
                        Payment Information
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="paymentForm">
                        {% csrf_token %}
                        
                        <!-- Payment Amount -->
                        <div class="mb-4">
                            <label for="payment_amount" class="form-label">Payment Amount (MVR)</label>
                            <div class="input-group">
                                <span class="input-group-text">MVR</span>
                                <input type="number" class="form-control" id="payment_amount" name="payment_amount" 
                                       value="{{ fine.balance }}" min="0.01" max="{{ fine.balance }}" step="0.01" required>
                            </div>
                            <div class="form-text">
                                Maximum payable: MVR {{ fine.balance }}
                            </div>
                        </div>

                        <!-- Payment Method Selection -->
                        <div class="mb-4">
                            <label class="form-label">Select Payment Method</label>
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <div class="card payment-method-card" onclick="selectPaymentMethod('cash')">
                                        <div class="card-body text-center">
                                            <i class="fas fa-money-bill-alt fa-2x text-success mb-2"></i>
                                            <h6>Cash</h6>
                                            <small class="text-muted">Pay at library counter</small>
                                        </div>
                                    </div>
                                    <input type="radio" class="d-none" name="payment_method" value="cash" id="cash">
                                </div>
                                <div class="col-6 mb-3">
                                    <div class="card payment-method-card" onclick="selectPaymentMethod('card')">
                                        <div class="card-body text-center">
                                            <i class="fas fa-credit-card fa-2x text-primary mb-2"></i>
                                            <h6>Card</h6>
                                            <small class="text-muted">Credit/Debit card</small>
                                        </div>
                                    </div>
                                    <input type="radio" class="d-none" name="payment_method" value="card" id="card">
                                </div>
                                <div class="col-6 mb-3">
                                    <div class="card payment-method-card" onclick="selectPaymentMethod('bank_transfer')">
                                        <div class="card-body text-center">
                                            <i class="fas fa-university fa-2x text-info mb-2"></i>
                                            <h6>Bank Transfer</h6>
                                            <small class="text-muted">Online banking</small>
                                        </div>
                                    </div>
                                    <input type="radio" class="d-none" name="payment_method" value="bank_transfer" id="bank_transfer">
                                </div>
                                <div class="col-6 mb-3">
                                    <div class="card payment-method-card" onclick="selectPaymentMethod('mobile_payment')">
                                        <div class="card-body text-center">
                                            <i class="fas fa-mobile-alt fa-2x text-warning mb-2"></i>
                                            <h6>Mobile Payment</h6>
                                            <small class="text-muted">Mobile wallet</small>
                                        </div>
                                    </div>
                                    <input type="radio" class="d-none" name="payment_method" value="mobile_payment" id="mobile_payment">
                                </div>
                            </div>
                        </div>

                        <!-- Additional Notes -->
                        <div class="mb-4">
                            <label for="notes" class="form-label">Additional Notes (Optional)</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3" 
                                    placeholder="Any additional information about this payment"></textarea>
                        </div>

                        <!-- Payment Summary -->
                        <div class="payment-summary p-3 mb-4">
                            <h6><i class="fas fa-receipt me-2"></i>Payment Summary</h6>
                            <div class="row">
                                <div class="col-6">
                                    <strong>Fine Amount:</strong>
                                </div>
                                <div class="col-6 text-end">
                                    MVR {{ fine.amount }}
                                </div>
                            </div>
                            {% if fine.amount_paid > 0 %}
                            <div class="row">
                                <div class="col-6">
                                    <strong>Previously Paid:</strong>
                                </div>
                                <div class="col-6 text-end text-success">
                                    MVR {{ fine.amount_paid }}
                                </div>
                            </div>
                            {% endif %}
                            <hr>
                            <div class="row">
                                <div class="col-6">
                                    <strong>Amount to Pay:</strong>
                                </div>
                                <div class="col-6 text-end">
                                    <span class="fw-bold text-primary" id="paymentAmount">MVR {{ fine.balance }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-credit-card me-2"></i>
                                Process Payment
                            </button>
                            <a href="{% url 'fines:list' %}" class="btn btn-outline-secondary">
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Instructions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Payment Instructions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-money-bill-alt text-success me-2"></i>Cash Payment</h6>
                            <ul class="small">
                                <li>Visit any library branch counter</li>
                                <li>Present your library card or ID</li>
                                <li>Pay the exact amount to staff</li>
                                <li>Collect your receipt</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-credit-card text-primary me-2"></i>Card Payment</h6>
                            <ul class="small">
                                <li>Secure online payment processing</li>
                                <li>Visa, MasterCard, and local cards accepted</li>
                                <li>Instant confirmation and receipt</li>
                                <li>Payment processed immediately</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3" role="alert">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>Note:</strong> Once payment is processed, your library privileges will be restored immediately. 
                        Keep your receipt for your records.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    function selectPaymentMethod(method) {
        // Remove selected class from all cards
        document.querySelectorAll('.payment-method-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // Add selected class to clicked card
        event.currentTarget.classList.add('selected');
        
        // Select the radio button
        document.getElementById(method).checked = true;
    }

    // Update payment amount display when input changes
    document.getElementById('payment_amount').addEventListener('input', function() {
        const amount = parseFloat(this.value) || 0;
        document.getElementById('paymentAmount').textContent = `MVR ${amount.toFixed(2)}`;
    });

    // Form validation
    document.getElementById('paymentForm').addEventListener('submit', function(e) {
        const paymentMethod = document.querySelector('input[name="payment_method"]:checked');
        const paymentAmount = parseFloat(document.getElementById('payment_amount').value);
        const maxAmount = parseFloat('{{ fine.balance }}');
        
        if (!paymentMethod) {
            e.preventDefault();
            alert('Please select a payment method.');
            return false;
        }
        
        if (paymentAmount <= 0 || paymentAmount > maxAmount) {
            e.preventDefault();
            alert(`Payment amount must be between MVR 0.01 and MVR ${maxAmount.toFixed(2)}.`);
            return false;
        }
        
        // Show confirmation dialog
        const confirmation = confirm(`Confirm payment of MVR ${paymentAmount.toFixed(2)} using ${paymentMethod.value.replace('_', ' ')}?`);
        if (!confirmation) {
            e.preventDefault();
            return false;
        }
    });
</script>
{% endblock %}
{% endblock %}
